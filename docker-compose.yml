version: '3'

services:
    postgres:
        image: postgres:12.2
        restart: unless-stopped
        expose:
            - "5432"
        volumes:
            - ./postgres/data:/var/lib/postgresql/data

    php:
        image: nerdzeu/docker-php:1.0.0
        restart: unless-stopped
        expose:
            - "9000"
        links:
            - postgres
        volumes:
            - ./php/nerdz.eu:/var/www/html

    nginx:
        image: nginx:1.16-perl
        restart: unless-stopped
        ports:
            - "80:80"
            - "433:433"
        links:
            - php
        volumes_from:
            - php
        volumes:
            - ./nginx/conf.d:/etc/nginx/conf.d
            - ./certbot/conf:/etc/letsencrypt
            - ./certbot/www:/var/www/certbot
        command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off; load_module /etc/nginx/modules/ngx_http_perl_module.so;\"'"


    certbot:
        image: certbot/certbot
        restart: unless-stopped
        volumes:
          - ./certbot/conf:/etc/letsencrypt
          - ./certbot/www:/var/www/certbot
        entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

    camo:
        image: jostyee/camo:latest
        restart: unless-stopped
        expose:
            - "8081"
        links:
            - nginx
        volumes:
            - ./camo/camo:/opt/camo

    redis:
        image: redis:5.0
        restart: unless-stopped
        expose:
            - "6379"
        volumes:
            - ./nerdzcrush/redis:/data

    nerdzcrush:
        image: nerdzeu/docker-nerdzcrush:latest
        restart: unless-stopped
        expose:
            - "9999"
        links:
            - redis
        volumes:
            - ./nerdzcrush/mediacrush:/home/mediacrush

    api:
        image: nerdzeu/nerdz-api:1.0.0
        restart: unless-stopped
        expose:
            - "8080"
        links:
            - postgres
        volumes_from:
            - php
        volumes:
            - ./api/runtime:/go/runtime
        environment:
            - CONF_FILE=/go/runtime/config.json
